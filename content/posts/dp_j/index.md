---
title: Educational DP Contest / DP まとめコンテスト J - Sushi
date: 2020-04-01
categories:
  - 競プロ
tags:
  - AtCoder
  - 動的計画法
  - 期待値
---

# 問題情報
- 問題文: https://atcoder.jp/contests/dp/tasks/dp_j

# 観察
入力例1は解説の通り。入力例2は1皿なので明らかなので面白くない。
入力例3（$a = (1, 2)$）を手計算で計算してみよう。

寿司を食べる順番として考えられるパターンは以下の通り。
- パターン1: 皿1, 皿2, 皿2
- パターン2: 皿2, 皿1, 皿2
- パターン3: 皿2, 皿2, 皿1

各パターンになる確率とそのパターンにおける操作回数の期待値を求めてみる。
まずパターン1となる確率を求める。
初回の操作で皿1を選ぶ確率は $1/2$, 以降の操作で皿2を選ぶ確率は $1$ なので、
パターン1となる確率は $1/2 \cdot 1 \cdot 1 = 1/2$ である。
初回の操作では空の皿はないので、皿1の寿司を食べるまでの操作回数の期待値は $1$ である。
以降の操作では皿1が空なので、皿2の寿司を食べるまでの操作回数の期待値は $2$ である。
したがって、パターン1における操作回数の期待値は $1 + 2 + 2 = 5$ である。
同様に、他のパターンの確率と期待値を求めると以下の表のようになる。

|パターン|パターンとなる確率|操作回数の期待値|
|:--|:--|:--|
|パターン1|$1/2 \cdot 1 \cdot 1 = 1/2$|$1 + 2 + 2 = 5$|
|パターン2|$1/2 \cdot 1/2 \cdot 1 = 1/4$|$1 + 1 + 2 = 4$|
|パターン3|$1/2 \cdot 1/2 \cdot 1 = 1/4$|$1 + 1 + 2 = 4$|

したがって、全体の期待値は $1/2 \cdot 5 + 1/4 \cdot 4 + 1/4 \cdot 4 = 5/2 + 1 + 1 = 9/2 = 4.5$ となる。

# 考察
前述の実験の方法だと、皿の枚数に対してパターン数は組合せ爆発的に増加する。
まずはこれを何とかする。

制約をよく見ると皿に置かれている寿司の個数は高々3である。
つまり、初期状態における皿の種類は3種類しかない。
したがって、本問題は整数の組 $(x, y, z)$ で表現できる。
ここで、$x$ は寿司が3個置かれている皿の個数、 $y$ は寿司が2個置かれている皿の個数、 $z$ は寿司が1個置かれている皿の個数である。
操作途中の状態（部分問題）も $(x, y, z)$ で表現できるので、$O(N^3)$ の状態空間が見える。
動的計画法で解きたくなる（EDPCなので当然だけど）。

実験の例を状態空間に当てはめて観察してみよう。
初期状態は $(0, 1, 1)$ である。各パターンにおける状態遷移は以下となる。
- パターン1: $(0, 1, 1)$, $(0, 1, 0)$, $(0, 0, 1)$, $(0, 0, 0)$
- パターン2: $(0, 1, 1)$, $(0, 0, 2)$, $(0, 0, 1)$, $(0, 0, 0)$
- パターン3: $(0, 1, 1)$, $(0, 0, 2)$, $(0, 0, 1)$, $(0, 0, 0)$

パターン2とパターン3を同一視できるので、計算量を減らせそうである。
こうして書くと、3次元のマス盤に対する移動ルートの組合せを考える問題に近い。
しかし、パターン2の最初の移動は斜めであり、少し扱いづらい。
そこで、組 $(x, y, z)$ の解釈を以下の通り変更してみよう。
- $x$ は寿司が3個置かれている皿の個数
- $y$ は寿司が2個 **以上** 置かれている皿の個数
- $z$ は寿司が1個 **以上** 置かれている皿の個数

すると、初期状態は $(0, 1, 2)$ となる。各パターンにおける状態遷移は以下となる。
- パターン1: $(0, 1, 2)$, $(0, 1, 1)$, $(0, 0, 1)$, $(0, 0, 0)$
- パターン2: $(0, 1, 2)$, $(0, 0, 2)$, $(0, 0, 1)$, $(0, 0, 0)$
- パターン3: $(0, 1, 2)$, $(0, 0, 2)$, $(0, 0, 1)$, $(0, 0, 0)$

パターン2の最初の移動が $y$ 軸に沿った移動になった。以降は、こちらの定義を採用する。

ここまで来ると、問題を以下で言い換えられる（ざっくりした表現だが）。

> 3次元のマス盤が与えられる。あなたはマス $(x, y, z)$ にいる。
あなたはx軸, y軸, z軸, ハズレからランダム（確率はマスに応じて変わる）に一つ選び、その軸について-1だけ移動する（負の座標には行けない）。
ただしハズレを選ぶと移動できない。
この操作を繰り返し $(0, 0, 0)$ に到達したとき、操作回数の期待値を求めよ。


マス $(i, j, k)$ から開始したときの操作回数の期待値を $\mu_{i, j, k}$ とし、 $\mu_{0, 0, 0}, \mu_{0, 0, 1}, \mu_{0, 1, 1}, \mu_{1, 1, 1}, \mu_{0, 0, 2}, \mu_{0, 1, 2}, ...$ とボトムアップに $\mu$ を計算すればよい（典型的な動的計画法である）。

最後に $\mu$ の漸化式を立式しよう（ここからはただの数学である）。
簡単な例として $N = 2$ における $\mu_{0, 1, 2}$ を計算する式を考える。
前述の状態遷移より、 $\mu_{0, 1, 1}$ と $\mu_{0, 0, 2}$ に関する式になる。
$(0, 1, 2)$ から $(0, 1, 1)$ に移動する確率は、寿司が1個置かれている皿（そのような皿は $k - j$ 個ある）を選ぶ確率に等しいので、$(2 - 1) / 2 = 1/2$ である。
$(0, 1, 2)$ から $(0, 0, 2)$ に移動する確率は、寿司が2個置かれている皿（そのような皿は $j - i$ 個ある）を選ぶ確率に等しいので $(1 - 0) / 2 = 1/2$ である。
$(0, 1, 2)$ から $(0, 1, 1)$ に移動するのに必要な操作回数の期待値は寿司が置かれている皿を選ぶ確率の逆数に等しい（つまり、 $N/k$）ので $2 / 2 = 1$ である。
$(0, 1, 2)$ から $(0, 0, 2)$ に移動するのに必要な操作回数の期待値も同様に $1$ である。
したがって、 $\mu_{0, 1, 2} = 1/2 \cdot (\mu_{0, 1, 1} + 1) + 1/2 \cdot (\mu_{0, 0, 2} + 1)$ が成り立つ。

次に $N = 2$ における $\mu_{0, 0, 1}$ を計算する式を考える。
前述の状態遷移より、 $\mu_{0, 0, 0}$ に関する式になる。
$(0, 0, 1)$ から $(0, 0, 0)$ に移動する確率は $(1 - 0) / 1 = 1$ である（これは計算せずとも明らかである）。
$(0, 0, 1)$ から $(0, 0, 0)$ に移動するのに必要な操作回数の期待値は $2 / 1 = 2$ となる。
したがって、 $\mu_{0, 0, 1} = 1 \cdot (\mu_{0, 0, 0} + 2)$ が成り立つ。

一般化すると以下となる。

$$
\begin{align}
  \mu_{i, j, k}
  &= (i/k) (\mu_{i - 1, j, k} + N / k) + ((j - i)/k) (\mu_{i, j - 1, k} + N / k) + ((k - j)/k) (\mu_{i, j, k - 1} + N / k) \\\\
  &= (i \mu_{i - 1, j, k} + (j - i) \mu_{i, j - 1, k} + (k - j) \mu_{i, j, k - 1} + N)/k
\end{align}
$$

ただし、 $\mu_{0, 0, 0} = 0$ である。

# 実装
$\mu$ の計算は漸化式にしたがって愚直に3重のforループを回すだけでよい。添字が負の場合に注意する。
スタート地点 $(x, y, z)$ も素直なカウンティングで求められる。

# 教訓
- トップダウンで複雑になりそうなら、ボトムアップでも考えてみるべき
- 漸化式を詰めると実装は楽になる
- いわゆる45度回転するとシンプルな問題に帰着でき、多重forループで簡潔に解ける
